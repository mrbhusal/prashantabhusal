<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mr. Bhusal - Service Order Form</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="icon" href="logopb.png" type="image/png" />
   <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      color: #1f2937;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .form-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 6px 25px rgba(59, 130, 246, 0.2);
      width: 100%;
      max-width: 600px;
      padding: 2rem 2.5rem;
      animation: fadeIn 0.6s ease forwards;
    }
    h2 {
      font-weight: 700;
      font-size: 1.75rem;
      color: #2563eb;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    /* Progress Bar */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      counter-reset: step;
    }
    .progress-step {
      width: 50px;
      height: 50px;
      position: relative;
      text-align: center;
      color: #9ca3af;
      cursor: default;
      user-select: none;
      border-radius: 50%;
      border: 2px solid #9ca3af;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: all 0.3s ease;
    }
    .progress-step.active,
    .progress-step.completed {
      color: white;
      background: #2563eb;
      border-color: #2563eb;
      box-shadow: 0 0 10px #2563eb88;
    }
    .progress-step.completed {
      background: #2563eb;
    }
    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 22px;
      left: 55px;
      width: calc(100% - 60px);
      height: 3px;
      background: #9ca3af;
      z-index: -1;
      transition: background 0.3s ease;
    }
    .progress-step.completed:not(:last-child)::after {
      background: #2563eb;
    }

    /* Tooltips for progress steps */
    .progress-step[aria-label] {
      position: relative;
    }
    .progress-step[aria-label]:hover::after {
      content: attr(aria-label);
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #2563eb;
      color: white;
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 4px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    .progress-step[aria-label]::after {
      opacity: 0;
      pointer-events: none;
    }

    /* Form Steps */
    form > div {
      display: none;
      animation: slideIn 0.5s ease forwards;
    }
    form > div.active {
      display: block;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      user-select: none;
    }
    input[type="text"],
    input[type="email"],
    input[type="date"],
    select,
    input[type="tel"] {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: none;
      background: #f3f4f6;
      color: #1f2937;
      font-size: 1rem;
      margin-bottom: 1.25rem;
      box-shadow: inset 0 0 5px #3b82f666;
      transition: box-shadow 0.3s ease;
      user-select: text;
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    select:focus,
    input[type="tel"]:focus {
      outline: none;
      box-shadow: 0 0 12px #3b82f6cc;
      background: #fff;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }
    button {
      background: #3b82f6;
      color: white;
      font-weight: 700;
      padding: 0.75rem 1.75rem;
      border-radius: 9999px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 6px 12px #3b82f6cc;
      min-width: 120px;
    }
    button:hover:not(:disabled) {
      background: #2563eb;
      box-shadow: 0 8px 20px #2563ebcc;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }
    /* Payment preview box */
    .payment-preview {
      background: #eff6ff;
      border: 2px solid #2563eb;
      border-radius: 1rem;
      padding: 1rem 1.5rem;
      margin-top: 1.5rem;
      color: #1e40af;
      font-weight: 600;
      user-select: none;
      line-height: 1.4;
      font-size: 1rem;
      white-space: pre-line;
    }
    /* Conditional payment fields */
    .conditional-field {
      display: none;
      animation: fadeIn 0.4s ease forwards;
    }
    .conditional-field.active {
      display: block;
    }
    /* Services list as select */
    select#service {
      cursor: pointer;
    }
    /* Animations */
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    /* Disabled payment methods */
    .disabled-option {
      color: #9ca3af;
      font-style: italic;
    }
  </style>
</head>
<body>

  <section class="form-container" aria-label="Service order form">
    <h2>Order Your Service</h2>

    <!-- Progress Bar with icons -->
    <div class="progress-bar" aria-label="Form progress">
      <div class="progress-step active" aria-current="step" aria-label="Select Service">
        <i class="fas fa-list-ul" title="Select Service"></i>
      </div>
      <div class="progress-step" aria-label="Order Details">
        <i class="fas fa-info-circle" title="Order Details"></i>
      </div>
      <div class="progress-step" aria-label="Payment Method">
        <i class="fas fa-credit-card" title="Payment Method"></i>
      </div>
      <div class="progress-step" aria-label="Preview & Submit">
        <i class="fas fa-eye" title="Preview & Submit"></i>
      </div>
    </div>

    <form id="order-form" novalidate>

      <!-- Step 1: Select Service -->
      <div class="step active" data-step="1" aria-live="polite">
        <label for="service">Choose a Service</label>
        <select id="service" name="service" required aria-required="true" aria-describedby="serviceHelp">
          <option value="" disabled selected>Select a service</option>
          <option value="Logo Design" data-price="200">Logo Design - Rs. 200</option>
          <option value="Graphic Design" data-price="150">Graphic Design - Rs. 150</option>
          <option value="Presentation Design" data-price="100">Presentation Design - Rs. 100</option>
          <option value="Web Development" data-price="3000">Web Development - Rs. 3000</option>
          <option value="Social Media Management" data-price="2000">Social Media Management - Rs. 2000</option>
        </select>
        <small id="serviceHelp" class="text-gray-500">Pick one of the available services.</small>
        <div class="buttons">
          <button type="button" disabled>Back</button>
          <button type="button" id="nextBtn1" disabled>Next</button>
        </div>
      </div>

      <!-- Step 2: Order Details -->
      <div class="step" data-step="2" aria-live="polite">
        <label for="full-name">Full Name</label>
        <input type="text" id="full-name" name="full-name" placeholder="Your full name" required aria-required="true" />

        <label for="email">Email Address</label>
        <input type="email" id="email" name="email" placeholder="you@example.com" required aria-required="true" />

        <label for="due-date">Preferred Due Date</label>
        <input type="date" id="due-date" name="due-date" required aria-required="true" min="" />

        <div class="buttons">
          <button type="button" id="backBtn2">Back</button>
          <button type="button" id="nextBtn2" disabled>Next</button>
        </div>
      </div>

      <!-- Step 3: Payment -->
      <div class="step" data-step="3" aria-live="polite">
        <label for="payment-method">Payment Method</label>
        <select id="payment-method" name="payment-method" required aria-required="true">
          <option value="" disabled selected>Select payment method</option>
          <option value="credit-card">Credit Card</option>
          <option value="esewa">eSewa (9766654639)</option>
         <option value="pay-later">PAY LATER</option>
        </select>

        <!-- Credit Card Fields -->
        <div id="credit-card-fields" class="conditional-field" aria-hidden="true">
          <label for="card-number">Card Number</label>
          <input type="text" id="card-number" name="card-number" placeholder="1234 5678 9012 3456" maxlength="19" inputmode="numeric" />

          <label for="expiry-date">Expiry Date (MM/YY)</label>
          <input type="text" id="expiry-date" name="expiry-date" placeholder="MM/YY" maxlength="5" pattern="^(0[1-9]|1[0-2])\/\d{2}$" />

          <label for="cvv">CVV</label>
          <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4" inputmode="numeric" />
        </div>

        <!-- eSewa Info -->
        <div id="esewa-fields" class="conditional-field" aria-hidden="true">
          <p class="text-gray-700 mb-4">
            Please send the payment to eSewa number: <strong>9766654639</strong><br />
            After payment, enter your transaction ID below.
          </p>
          <label for="esewa-transaction-id">Transaction ID</label>
          <input type="text" id="esewa-transaction-id" name="esewa-transaction-id" placeholder="Enter eSewa transaction ID" />
        </div>

        <!-- Pay Cash by Calling -->
        <div id="pay-cash-fields" class="conditional-field" aria-hidden="true">
          <p class="text-gray-700 mb-2">
            Please enter your phone number to receive an OTP to confirm your order.
          </p>
          <label for="cash-phone">Phone Number</label>
          <input type="tel" id="cash-phone" name="cash-phone" placeholder="+977 98XXXXXXXX"  />

          <div id="otp-section" style="display:none; margin-top:1rem;">
            <label for="otp-input">Enter OTP</label>
            <input type="text" id="otp-input" maxlength="6" pattern="\d{6}" placeholder="6-digit OTP" inputmode="numeric" />
            <button type="button" id="verify-otp-btn" style="margin-top:0.5rem; background:#2563eb; color:#fff; padding:0.5rem 1rem; border:none; border-radius:9999px; cursor:pointer;">Verify OTP</button>
            <p id="otp-message" style="color:red; margin-top:0.5rem;"></p>
          </div>
        </div>

        <!-- Bank Transfer Fields (disabled) -->
        <div id="bank-transfer-fields" class="conditional-field" aria-hidden="true">
          <p class="text-gray-500 italic">Bank Transfer payment method is currently under development.</p>
        </div>

        <!-- Email Payment Fields (disabled) -->
        <div id="email-payment-fields" class="conditional-field" aria-hidden="true">
          <p class="text-gray-500 italic">Payment via Mr. Bhusal's email is currently under development.</p>
        </div>

        <div class="buttons">
          <button type="button" id="backBtn3">Back</button>
          <button type="button" id="nextBtn3" disabled>Next</button>
        </div>
      </div>

      <!-- Step 4: Preview & Submit -->
      <div class="step" data-step="4" aria-live="polite">
        <h3 class="mb-4 font-semibold text-lg text-center">Order Summary</h3>
        <div class="payment-preview" id="order-summary" aria-live="polite" aria-atomic="true">
          <!-- Summary details filled by JS -->
        </div>

        <div class="buttons">
          <button type="button" id="backBtn4">Back</button>
          <button type="submit" id="submitBtn">Submit Order</button>
        </div>
      </div>

    </form>
  </section>

 <!-- Your existing HTML stays the same -->

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
  (function(){
    // Initialize EmailJS (replace YOUR_PUBLIC_KEY)
    emailjs.init("v-TBqWppfClYlat8A");

    // Elements and variables same as before...
    const form = document.getElementById('order-form');
    const steps = Array.from(form.querySelectorAll('.step'));
    const progressSteps = Array.from(document.querySelectorAll('.progress-step'));

    let currentStep = 0;

    // Buttons
    const btnNext1 = document.getElementById('nextBtn1');
    const btnNext2 = document.getElementById('nextBtn2');
    const btnNext3 = document.getElementById('nextBtn3');

    const btnBack2 = document.getElementById('backBtn2');
    const btnBack3 = document.getElementById('backBtn3');
    const btnBack4 = document.getElementById('backBtn4');

    const submitBtn = document.getElementById('submitBtn');

    // Inputs step1
    const selectService = document.getElementById('service');

    // Inputs step2
    const inputName = document.getElementById('full-name');
    const inputEmail = document.getElementById('email');
    const inputDate = document.getElementById('due-date');

    // Inputs step3
    const paymentMethod = document.getElementById('payment-method');

    const ccFields = document.getElementById('credit-card-fields');
    const esewaFields = document.getElementById('esewa-fields');
    const bankFields = document.getElementById('bank-transfer-fields');
    const emailPaymentFields = document.getElementById('email-payment-fields');

    // Credit card inputs
    const ccNumber = document.getElementById('card-number');
    const ccExpiry = document.getElementById('expiry-date');
    const ccCvv = document.getElementById('cvv');

    // eSewa input
    const esewaTxId = document.getElementById('esewa-transaction-id');

    // Summary box
    const summaryBox = document.getElementById('order-summary');

    // Utility: Set min date for date input (today)
    const todayISO = new Date().toISOString().split('T')[0];
    inputDate.min = todayISO;

    // Show a step
    function showStep(index){
      if(index < 0 || index >= steps.length) return;
      currentStep = index;
      steps.forEach((step, i) => {
        step.classList.toggle('active', i === index);
        progressSteps[i].classList.toggle('active', i === index);
        progressSteps[i].classList.toggle('completed', i < index);
      });
      validateCurrentStep();
    }

    // Validate functions
    function validateStep1(){
      btnNext1.disabled = selectService.value === '';
    }

    function validateStep2(){
      const nameValid = inputName.value.trim().length > 1;
      const emailValid = inputEmail.checkValidity();
      const dateValid = inputDate.value !== '' && inputDate.value >= todayISO;
      btnNext2.disabled = !(nameValid && emailValid && dateValid);
    }

    function validateCreditCard(){
      // Improved basic checks - card number (Luhn check), expiry date format, CVV length
      const number = ccNumber.value.replace(/\s+/g, '');
      if (!/^\d{13,19}$/.test(number)) return false;

      // Luhn Algorithm for card validation
      function luhnCheck(num) {
        let sum = 0;
        let shouldDouble = false;
        for(let i = num.length - 1; i >= 0; i--) {
          let digit = parseInt(num.charAt(i));
          if(shouldDouble) {
            digit *= 2;
            if(digit > 9) digit -= 9;
          }
          sum += digit;
          shouldDouble = !shouldDouble;
        }
        return (sum % 10) === 0;
      }
      if(!luhnCheck(number)) return false;

      if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(ccExpiry.value)) return false;

      if(!/^\d{3,4}$/.test(ccCvv.value)) return false;

      // Optional: Check expiry date is not past
      const [month, year] = ccExpiry.value.split('/');
      const expiryDate = new Date(2000 + parseInt(year), parseInt(month));
      if(expiryDate < new Date()) return false;

      return true;
    }

    function validatePaymentStep(){
      const method = paymentMethod.value;
      if(method === '') {
        btnNext3.disabled = true;
        return;
      }
      if(method === 'credit-card'){
        btnNext3.disabled = !validateCreditCard();
      } else if(method === 'esewa'){
        btnNext3.disabled = esewaTxId.value.trim() === '';
      } else if(method === 'pay-later'){
        // Pay later requires no validation, always enable next
        btnNext3.disabled = false;
      } else {
        // Disabled payment methods - disable Next
        btnNext3.disabled = true;
      }
    }

    // Show/hide payment conditional fields
    function updatePaymentFields(){
      const method = paymentMethod.value;

      [ccFields, esewaFields, bankFields, emailPaymentFields].forEach(el => {
        el.classList.remove('active');
        el.setAttribute('aria-hidden', 'true');
      });

      if(method === 'credit-card'){
        ccFields.classList.add('active');
        ccFields.setAttribute('aria-hidden', 'false');
      } else if(method === 'esewa'){
        esewaFields.classList.add('active');
        esewaFields.setAttribute('aria-hidden', 'false');
      } else if(method === 'bank-transfer'){
        bankFields.classList.add('active');
        bankFields.setAttribute('aria-hidden', 'false');
      } else if(method === 'email-payment'){
        emailPaymentFields.classList.add('active');
        emailPaymentFields.setAttribute('aria-hidden', 'false');
      }
      // For pay-later, no fields are active

      validatePaymentStep();
    }

    // Event listeners

    // Step 1
    selectService.addEventListener('change', validateStep1);
    btnNext1.addEventListener('click', () => showStep(1));

    // Step 2
    [inputName, inputEmail, inputDate].forEach(input => input.addEventListener('input', validateStep2));
    btnBack2.addEventListener('click', () => showStep(0));
    btnNext2.addEventListener('click', () => showStep(2));

    // Step 3
    paymentMethod.addEventListener('change', updatePaymentFields);

    [ccNumber, ccExpiry, ccCvv].forEach(input => input.addEventListener('input', validatePaymentStep));
    esewaTxId.addEventListener('input', validatePaymentStep);

    btnBack3.addEventListener('click', () => showStep(1));
    btnNext3.addEventListener('click', () => {
      fillSummary();
      showStep(3);
    });

    // Step 4
    btnBack4.addEventListener('click', () => showStep(2));

    // Fill summary details
    function fillSummary(){
      const serviceText = selectService.options[selectService.selectedIndex].text;
      const name = inputName.value.trim();
      const email = inputEmail.value.trim();
      const date = inputDate.value;
      const payment = paymentMethod.options[paymentMethod.selectedIndex]?.text || '';

      let paymentDetails = '';
      if(paymentMethod.value === 'credit-card'){
        paymentDetails = 'Credit Card ending with ****' + (ccNumber.value.slice(-4));
      } else if(paymentMethod.value === 'esewa'){
        paymentDetails = 'Paid via eSewa with Transaction ID: ' + esewaTxId.value.trim();
      } else if(paymentMethod.value === 'pay-later'){
        paymentDetails = 'Payment will be made later.';
      } else if(paymentMethod.value === 'bank-transfer' || paymentMethod.value === 'email-payment'){
        paymentDetails = 'Payment method is under development.';
      }

      summaryBox.textContent = 
        `Service: ${serviceText}\n` +
        `Full Name: ${name}\n` +
        `Email: ${email}\n` +
        `Due Date: ${date}\n` +
        `Payment Method: ${payment}\n` +
        `${paymentDetails}`;
    }

    // Submit form with EmailJS
    form.addEventListener('submit', e => {
      e.preventDefault();

      // Basic form validation before sending
      if(selectService.value === '') {
        alert('Please select a service.');
        showStep(0);
        return;
      }
      if(inputName.value.trim().length < 2 || !inputEmail.checkValidity() || inputDate.value < todayISO) {
        alert('Please fill all order details correctly.');
        showStep(1);
        return;
      }
      if(paymentMethod.value === '') {
        alert('Please select a payment method.');
        showStep(2);
        return;
      }
      if(paymentMethod.value === 'credit-card' && !validateCreditCard()){
        alert('Please enter valid credit card information.');
        showStep(2);
        return;
      }
      if(paymentMethod.value === 'esewa' && esewaTxId.value.trim() === ''){
        alert('Please enter your eSewa transaction ID.');
        showStep(2);
        return;
      }
      // No validation needed for pay-later here

      // Prepare EmailJS template params
      const templateParams = {
        service_name: selectService.value,
        full_name: inputName.value.trim(),
        email: inputEmail.value.trim(),
        due_date: inputDate.value,
        payment_method: paymentMethod.options[paymentMethod.selectedIndex].text,
        payment_details: (function(){
          if(paymentMethod.value === 'credit-card'){
            return 'Credit Card ending with ****' + ccNumber.value.slice(-4);
          } else if(paymentMethod.value === 'esewa'){
            return 'eSewa TX ID: ' + esewaTxId.value.trim();
          } else if(paymentMethod.value === 'pay-later'){
            return 'Payment will be made later.';
          } else {
            return 'Payment method under development.';
          }
        })()
      };

      // Disable submit button to prevent multiple sends
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      // Send EmailJS email
      emailjs.send('mrbhusal', 'template_y8zhuoi', templateParams)
        .then(() => {
          alert('Order submitted successfully! Thank you.');
          form.reset();
          showStep(0);
          btnNext1.disabled = true;
          btnNext2.disabled = true;
          btnNext3.disabled = true;

          // Hide payment fields
          [ccFields, esewaFields, bankFields, emailPaymentFields].forEach(el => {
            el.classList.remove('active');
            el.setAttribute('aria-hidden', 'true');
          });

          summaryBox.textContent = '';
        }, (error) => {
          console.error('EmailJS error:', error);
          alert('Failed to send order. Please try again later.');
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Order';
        });
    });

    // Initial validation states
    validateStep1();
    validateStep2();
    validatePaymentStep();

    // Helper to validate the current step's next button
    function validateCurrentStep(){
      if(currentStep === 0) validateStep1();
      else if(currentStep === 1) validateStep2();
      else if(currentStep === 2) validatePaymentStep();
    }
  })();
</script>


</body>
</html>
